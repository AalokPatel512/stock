<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Options Chart Dashboard</title>
  <!-- Link to your LOCAL Chart.js file -->
  <script src="./chart.js"></script>
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #161a23;
      --card-bg: #1e2230;
      --accent-blue: #6366f1;
      --accent-pink: #ec4899;
      --text-primary: #ffffff;
      --text-secondary: #a3a3a3;
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 20%);
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 24px;
      background: linear-gradient(90deg, #6366f1, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background-color: var(--bg-secondary);
      border: 1px solid #2d3242;
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }
    .tab:hover,
    .tab.active {
      background-color: var(--accent-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .tab.active {
      font-weight: 600;
    }
    /* Control Bar */
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      background-color: var(--card-bg);
      padding: 18px;
      border-radius: var(--border-radius);
      border: 1px solid #2d3242;
      margin-bottom: 24px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .dropdown-group {
      display: flex;
      flex-direction: column;
      min-width: 180px;
    }
    .dropdown-group label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .dropdown-group select {
      padding: 10px;
      background-color: #252a38;
      color: var(--text-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }
    .price {
      text-align: center;
      font-size: 14px;
    }
    .price div {
      margin: 4px 0;
    }
    .green {
      color: #4ade80;
      font-weight: 500;
    }
    .red {
      color: #f87171;
      font-weight: 500;
    }
    .refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .refresh-toggle label {
      color: var(--text-secondary);
    }
    .refresh-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-blue);
      cursor: pointer;
    }
    /* Auto Refresh Dropdown */
    .auto-refresh-dropdown {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .auto-refresh-dropdown select {
      padding: 8px;
      background-color: #252a38;
      color: var(--text-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }
    /* Chart Container */
    .chart-container {
      background-color: var(--card-bg);
      border: 1px solid #2d3242;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      min-height: 400px; /* Ensure container has height even before chart loads */
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
      border-radius: 8px;
    }
    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 14px;
      margin-top: 10px;
    }
    .legend .put {
      color: #ec4899;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .legend .call {
      color: #6366f1;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .legend span::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .legend .put::before {
      background-color: #ec4899;
    }
    .legend .call::before {
      background-color: #6366f1;
    }
    @media (max-width: 768px) {
      .control-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Options Chart</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="open-interest">Open Interest</button>
      <button class="tab" data-tab="change-in-oi">Change in OI</button>
      <button class="tab" data-tab="put-call-ratio">Put Call Ratio</button>
      <button class="tab" data-tab="volume-pcr">Volume PCR</button>
      <button class="tab" data-tab="live-max-pain">Live Max Pain</button>
    </div>

    <!-- Control Bar -->
    <div class="control-bar">
      <div class="dropdown-group">
        <label for="symbol">Symbol</label>
        <select id="symbol">
          <option value="SBIN">SBIN</option>
          <option value="RELIANCE">RELIANCE</option>
          <option value="TCS">TCS</option>
          <option value="INFY">INFY</option>
          <option value="HDFCBANK">HDFC BANK</option>
          <option value="WIPRO">WIPRO</option>
          <!-- Add more symbols as needed -->
        </select>
      </div>
      <div class="price">
        <div><strong>Spot Price:</strong> <span id="spotPrice" class="green">--</span></div>
        <div>Max Pain: <strong id="maxPain">--</strong></div>
        <div>Lot Size: <strong id="lotSize">--</strong></div>
      </div>
      <div class="refresh-toggle">
        <label for="autoRefresh">Auto Refresh</label>
        <input type="checkbox" id="autoRefresh" checked />
      </div>
      <div class="auto-refresh-dropdown">
        <label for="refreshInterval">Interval:</label>
        <select id="refreshInterval">
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="30000">30s</option>
          <option value="60000" selected>1m</option>
        </select>
      </div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
      <canvas id="optionChart"></canvas>
    </div>

    <!-- Legend -->
    <div class="legend">
      <span class="put">PUT OI</span>
      <span class="call">CALL OI</span>
    </div>
  </div>

  <script>
    let optionChart; // Variable to hold the Chart.js instance

    // Simulated Lot Sizes (extend as needed)
    const lotSizes = {
      SBIN: 750,
      RELIANCE: 500,
      TCS: 300,
      INFY: 600,
      HDFCBANK: 550,
      WIPRO: 3000
    };

    // --- Data Fetching ---

    // Fetch real-time data from YOUR LOCAL BACKEND API
    async function fetchRealTimeData(symbol) {
      console.log(`Fetching data for ${symbol}...`);
      try {
        const response = await fetch(`http://localhost:5000/api/option-chain/${symbol}`);
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        const data = await response.json();
        console.log("Data fetched successfully:", data);
        return data;
      } catch (error) {
        console.error("Error fetching data from backend API:", error);
        return null;
      }
    }

    // --- Chart Rendering ---

    // Render Chart based on selected tab and fetched data
    function renderChart(chartData, activeTab) {
      console.log("Rendering chart for tab:", activeTab);
      const ctx = document.getElementById('optionChart').getContext('2d');

      // Destroy existing chart instance if it exists
      if (optionChart) {
        console.log("Destroying previous chart instance.");
        optionChart.destroy();
        optionChart = null;
      }

      // Check if canvas context is available
      if (!ctx) {
        console.error("Failed to get canvas context.");
        return;
      }

      let config = {}; // Chart configuration object

      // --- Configure chart based on active tab ---
      switch (activeTab) {
        case 'open-interest':
          config = {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'PUT OI',
                  data: chartData.putOi,
                  backgroundColor: '#ec4899',
                  borderRadius: 6,
                  barPercentage: 0.7,
                  categoryPercentage: 0.7,
                },
                {
                  label: 'CALL OI',
                  data: chartData.callOi,
                  backgroundColor: '#6366f1',
                  borderRadius: 6,
                  barPercentage: 0.7,
                  categoryPercentage: 0.7,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  enabled: true,
                  mode: 'index',
                  intersect: false,
                  backgroundColor: '#222',
                  titleColor: '#fff',
                  bodyColor: '#ddd',
                  borderColor: '#6366f1',
                  borderWidth: 1,
                  cornerRadius: 8,
                  displayColors: false,
                  callbacks: {
                    title: (items) => `Strike Price: ${items[0].label}`,
                    label: (item) => {
                      const value = item.parsed.y;
                      const label = item.dataset.label;
                      return `${label}: ${value.toLocaleString()}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Strike Price', color: '#808080', font: { size: 14 } },
                  grid: { color: '#333' },
                  ticks: { color: '#a3a3a3', font: { size: 12 } }
                },
                y: {
                  title: { display: true, text: 'Open Interest', color: '#808080', font: { size: 14 } },
                  grid: { color: '#333' },
                  ticks: {
                    color: '#a3a3a3',
                    font: { size: 12 },
                    callback: function (value) {
                      if (value >= 10000000) return (value / 10000000).toFixed(2) + 'Cr';
                      if (value >= 100000) return (value / 100000).toFixed(2) + 'L';
                      return value;
                    }
                  }
                }
              }
            }
          };
          break;

        case 'change-in-oi':
          config = {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'PUT CHNG OI',
                  data: chartData.putChngOi,
                  backgroundColor: '#f96c92',
                  borderRadius: 4,
                  barPercentage: 0.7,
                  categoryPercentage: 0.6,
                },
                {
                  label: 'CALL CHNG OI',
                  data: chartData.callChngOi,
                  backgroundColor: '#2196f3',
                  borderRadius: 4,
                  barPercentage: 0.7,
                  categoryPercentage: 0.6,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  enabled: true,
                  mode: 'index',
                  intersect: false,
                  backgroundColor: '#222',
                  titleColor: '#fff',
                  bodyColor: '#ddd',
                  borderColor: '#8884d8',
                  borderWidth: 1,
                  cornerRadius: 8,
                  displayColors: false,
                  callbacks: {
                    title: (items) => `Strike Price: ${items[0].label}`,
                    label: (item) => {
                      const value = item.parsed.y;
                      const label = item.dataset.label;
                      const sign = value >= 0 ? '+' : '';
                      return `${label}: ${sign}${value.toLocaleString()}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Strike Price', color: '#808080', font: { size: 14 } },
                  grid: { color: '#333' },
                  ticks: { color: '#a3a3a3', font: { size: 12 } }
                },
                y: {
                  title: { display: true, text: 'Change in OI', color: '#808080', font: { size: 14 } },
                  grid: { color: '#333' },
                  ticks: {
                    color: '#a3a3a3',
                    font: { size: 12 },
                    callback: function (value) {
                      if (value >= 10000000) return (value / 10000000).toFixed(2) + 'Cr';
                      if (value >= 100000) return (value / 100000).toFixed(2) + 'L';
                      return value;
                    }
                  }
                }
              }
            }
          };
          break;

        case 'put-call-ratio':
        case 'volume-pcr':
        case 'live-max-pain':
          // For these tabs, we'll create a simple line chart placeholder
          // You can replace this logic with specific data fetching/rendering for PCR/Max Pain
          const times = ['09:15', '10:00', '10:45', '11:30', '12:15', '13:00', '14:00', '15:00'];
          // Placeholder data - replace with actual PCR/Max Pain logic if available from API
          const placeholderData1 = chartData.labels ? chartData.labels.map((_, i) => Math.random() * 100) : [820, 822, 821, 824, 823, 825, 826, 824];
          const placeholderData2 = chartData.labels ? chartData.labels.map((_, i) => Math.random() * 100 + 800) : [0.8, 0.75, 0.78, 0.72, 0.70, 0.68, 0.65, 0.62];

          config = {
            type: 'line',
            data: {
              labels: times, // Use time labels for line chart
              datasets: [
                {
                  label: activeTab === 'live-max-pain' ? 'Max Pain' : (activeTab === 'put-call-ratio' ? 'PCR' : 'Volume PCR'),
                  data: activeTab === 'live-max-pain' ? placeholderData2.map(p => p + 10) : placeholderData2,
                  borderColor: '#6366f1',
                  backgroundColor: 'rgba(99, 102, 241, 0.1)',
                  fill: false,
                  tension: 0.3,
                  yAxisID: 'y'
                },
                {
                  label: 'Spot Price',
                  data: placeholderData1,
                  borderColor: '#ec4899',
                  backgroundColor: 'rgba(236, 72, 153, 0.1)',
                  fill: false,
                  tension: 0.3,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#ccc', font: { size: 12 } } }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Time', color: '#808080', font: { size: 14 } },
                  grid: { color: '#333' },
                  ticks: { color: '#a3a3a3', font: { size: 12 } }
                },
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                    display: true,
                    text: activeTab === 'live-max-pain' ? 'Max Pain' : (activeTab === 'put-call-ratio' ? 'PCR' : 'Volume PCR'),
                    color: '#808080',
                    font: { size: 14 }
                  },
                  grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                  ticks: { color: '#a3a3a3', font: { size: 12 } }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Spot Price',
                    color: '#808080',
                    font: { size: 14 }
                  },
                  grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                  ticks: { color: '#a3a3a3', font: { size: 12 } }
                }
              }
            }
          };
          break;

        default:
          console.warn("Unknown tab selected for chart rendering:", activeTab);
          return; // Exit if unknown tab
      }

      // --- Create the new Chart instance ---
      console.log("Creating new Chart instance with config:", config);
      try {
        optionChart = new Chart(ctx, config);
        console.log("Chart created successfully.");
      } catch (chartError) {
        console.error("Error creating Chart.js instance:", chartError);
      }
    }

    // --- UI Update Logic ---

    // Update Spot Price, Max Pain, Lot Size, and Chart using fetched data
    async function updateStockData() {
      console.log("Updating stock data...");
      const symbol = document.getElementById("symbol").value;
      const spotPriceEl = document.getElementById("spotPrice");
      const maxPainEl = document.getElementById("maxPain");
      const lotSizeEl = document.getElementById("lotSize");

      // Fetch data from backend
      const nseData = await fetchRealTimeData(symbol);

      if (nseData && !nseData.error) {
        // Update UI elements with fetched data
        const { underlyingValue, maxPain, lotSize, chartData } = nseData;
        spotPriceEl.textContent = underlyingValue ? underlyingValue.toFixed(2) : "--";
        spotPriceEl.className = underlyingValue >= 0 ? "green" : "red"; // Assuming positive is green
        maxPainEl.textContent = maxPain || "--";
        lotSizeEl.textContent = lotSize || lotSizes[symbol] || "--"; // Fallback to predefined lot size

        // Determine the currently active tab
        const activeTabElement = document.querySelector('.tab.active');
        const activeTab = activeTabElement ? activeTabElement.getAttribute('data-tab') : 'open-interest';

        // Render the chart with the fetched data and active tab
        if (chartData) {
            renderChart(chartData, activeTab);
        } else {
            console.warn("No chartData found in API response.");
            // Optionally, clear the chart or show a message
             if (optionChart) {
                optionChart.destroy();
                optionChart = null;
             }
             const ctx = document.getElementById('optionChart').getContext('2d');
             if (ctx) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.font = "20px Arial";
                 ctx.fillStyle = "white";
                 ctx.textAlign = "center";
                 ctx.fillText("No chart data available", ctx.canvas.width / 2, ctx.canvas.height / 2);
             }
        }

      } else {
        // Handle case where data fetch failed or returned an error
        console.error("Failed to fetch valid data for", symbol);
        spotPriceEl.textContent = "--";
        spotPriceEl.className = "";
        maxPainEl.textContent = "--";
        lotSizeEl.textContent = "--";

        // Clear chart or show error
        if (optionChart) {
            optionChart.destroy();
            optionChart = null;
        }
        const ctx = document.getElementById('optionChart').getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = "20px Arial";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.fillText("Failed to load data", ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
      }
    }

    // --- Event Listeners ---

    // Tab Click
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function () {
        document.querySelector('.tab.active')?.classList.remove('active');
        this.classList.add('active');
        updateStockData(); // Re-render chart based on newly selected tab
      });
    });

    // Symbol Change
    document.getElementById('symbol').addEventListener('change', () => {
      updateStockData(); // Fetch and render data for the new symbol
    });

    // Auto Refresh
    let autoRefreshInterval;
    function startAutoRefresh() {
      clearInterval(autoRefreshInterval);
      const interval = parseInt(document.getElementById('refreshInterval').value, 10);
      autoRefreshInterval = setInterval(updateStockData, interval);
      console.log(`Auto-refresh started (every ${interval/1000}s).`);
    }

    function stopAutoRefresh() {
      clearInterval(autoRefreshInterval);
      console.log("Auto-refresh stopped.");
    }

    document.getElementById('autoRefresh').addEventListener('change', () => {
      if (document.getElementById('autoRefresh').checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });

    document.getElementById('refreshInterval').addEventListener('change', () => {
      if (document.getElementById('autoRefresh').checked) {
        startAutoRefresh(); // Restart with new interval
      }
    });

    // --- Initial Load ---
    window.addEventListener('DOMContentLoaded', (event) => {
      console.log("DOM fully loaded and parsed. Initializing dashboard...");
      // Initial data load
      updateStockData();

      // Start auto-refresh if checkbox is checked
      if (document.getElementById('autoRefresh').checked) {
        startAutoRefresh();
      }
    });
  </script>
</body>
</html>